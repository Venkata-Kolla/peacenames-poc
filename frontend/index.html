<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeaceNames - C-Grid Archive Browser</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2E7D32; --primary-light: #4CAF50; --primary-dark: #1B5E20;
            --secondary: #1565C0; --accent: #FF8F00;
            --bg: #F5F5F5; --card: #FFFFFF; --text: #212121; --text-sec: #757575; --border: #E0E0E0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 1rem 2rem; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 1.5rem; }
        .logo .subtitle { font-size: 0.875rem; opacity: 0.9; }
        .header-controls { display: flex; gap: 1rem; align-items: center; }
        .lang-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        
        /* Main Layout */
        .main-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        /* C-Grid Section */
        .cgrid-section { background: var(--card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cgrid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .cgrid-header h2 { font-size: 1.25rem; color: var(--primary-dark); }
        .cgrid-subtitle { color: var(--text-sec); font-size: 0.875rem; }
        
        /* 5x5 Grid */
        .cgrid-container { display: flex; justify-content: center; padding: 1rem 0; }
        .cgrid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; max-width: 550px; width: 100%; }
        .cgrid-cell { 
            aspect-ratio: 1; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            border: 3px solid transparent;
        }
        .cgrid-cell:hover { 
            transform: scale(1.08); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .cgrid-cell.selected {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.4);
        }
        .cgrid-cell img { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        .cgrid-cell .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.75);
            color: white;
            font-size: 0.6rem;
            padding: 3px 4px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: 600;
        }
        .cgrid-cell:hover .label { opacity: 1; }
        
        /* Column background colors - matching Liana's original cgrid.jpg */
        /* Col 1: Gray/Tan (WHERE), Col 2: Yellow (WHEN), Col 3: Green (WHAT), Col 4: Blue (HOW), Col 5: Pink (WHO) */
        .cgrid-cell.col-1 { background: #d4d0c8; }
        .cgrid-cell.col-2 { background: #f5e6a3; }
        .cgrid-cell.col-3 { background: #98d4a4; }
        .cgrid-cell.col-4 { background: #a8c8e8; }
        .cgrid-cell.col-5 { background: #e8c8d0; }
        
        .cgrid-cell.center-cell {
            background: #98d4a4;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cgrid-cell.center-cell img {
            width: 90%;
            height: 90%;
            object-fit: contain;
        }
        
        /* Dimension Labels - matching column colors */
        .dimension-labels { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .dim-label { 
            padding: 0.4rem 0.8rem; 
            border-radius: 6px; 
            font-size: 0.7rem; 
            font-weight: 600;
            border: 2px solid rgba(0,0,0,0.2);
        }
        .dim-label.where { background: #d4d0c8; color: #333; }
        .dim-label.when { background: #f5e6a3; color: #665500; }
        .dim-label.what { background: #98d4a4; color: #1a5c2a; }
        .dim-label.how { background: #a8c8e8; color: #1a4a6e; }
        .dim-label.who { background: #e8c8d0; color: #6e1a3a; }
        
        /* Selected Tags Display */
        .selected-section { background: var(--card); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .selected-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .selected-header h3 { font-size: 1rem; color: var(--text); }
        .clear-btn { background: none; border: 1px solid var(--text-sec); color: var(--text-sec); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .clear-btn:hover { border-color: var(--primary); color: var(--primary); }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 32px; }
        .selected-tag { 
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--primary-light); color: white; 
            padding: 0.25rem 0.5rem 0.25rem 0.75rem; 
            border-radius: 20px; font-size: 0.8rem;
        }
        .selected-tag img { width: 20px; height: 20px; border-radius: 4px; }
        .selected-tag .remove { cursor: pointer; font-weight: bold; opacity: 0.8; }
        .selected-tag .remove:hover { opacity: 1; }
        .file-count { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        
        /* Files Section */
        .files-section { background: var(--card); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .files-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .files-header h3 { font-size: 1rem; }
        .upload-btn { background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.875rem; }
        .upload-btn:hover { background: #F57C00; }
        
        /* Files Grid */
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .file-card { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .file-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .file-preview { height: 120px; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
        .file-info { padding: 0.75rem; }
        .file-name { font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; }
        .file-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .file-tag { font-size: 0.6rem; padding: 2px 6px; background: #E8F5E9; color: var(--primary-dark); border-radius: 4px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 2rem; color: var(--text-sec); }
        .empty-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem; }
        .form-group textarea { min-height: 60px; resize: vertical; }
        
        /* Tag Selector in Modal */
        .tag-grid-selector { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 0.5rem; }
        .tag-grid-selector .mini-cell { 
            aspect-ratio: 1; border-radius: 4px; cursor: pointer; 
            overflow: hidden; border: 2px solid transparent; 
            transition: all 0.2s;
        }
        .tag-grid-selector .mini-cell:hover { border-color: var(--primary-light); }
        .tag-grid-selector .mini-cell.selected { border-color: var(--primary); background: rgba(46,125,50,0.1); }
        .tag-grid-selector .mini-cell img { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.875rem; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-primary { background: var(--primary); border: none; color: white; }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 600px) {
            .cgrid { max-width: 320px; gap: 4px; }
            .header-content { flex-direction: column; gap: 0.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span style="font-size:2rem">üïäÔ∏è</span>
                <div>
                    <h1>PeaceNames</h1>
                    <div class="subtitle">ÂíåÂêàÊ≥®ÂÜå ‚Ä¢ C-Grid Archive Browser</div>
                </div>
            </div>
            <div class="header-controls">
                <button class="lang-toggle" onclick="toggleLang()"><span id="lang-ind">EN/‰∏≠</span></button>
            </div>
        </div>
    </header>
    
    <main class="main-container">
        <!-- C-Grid Visual -->
        <section class="cgrid-section">
            <div class="cgrid-header">
                <div>
                    <h2>üî≤ <span id="grid-title">C-Grid Navigator</span></h2>
                    <p class="cgrid-subtitle" id="grid-subtitle">Click icons to filter your files by category</p>
                </div>
            </div>
            
            <div class="cgrid-container">
                <div class="cgrid" id="cgrid">
                    <!-- Grid will be rendered by JavaScript -->
                </div>
            </div>
            
            <div class="dimension-labels">
                <span class="dim-label where">Col 1: WHERE Âì™Èáå</span>
                <span class="dim-label when">Col 2: WHEN ‰ΩïÊó∂</span>
                <span class="dim-label what">Col 3: WHAT ‰ªÄ‰πà</span>
                <span class="dim-label how">Col 4: HOW Â¶Ç‰Ωï</span>
                <span class="dim-label who">Col 5: WHO Ë∞Å</span>
            </div>
        </section>
        
        <!-- Selected Filters -->
        <section class="selected-section">
            <div class="selected-header">
                <h3><span class="file-count" id="file-count">0</span> <span id="files-label">files found</span></h3>
                <button class="clear-btn" onclick="clearFilters()" id="clear-btn">Clear All</button>
            </div>
            <div class="selected-tags" id="selected-tags">
                <span style="color: var(--text-sec); font-size: 0.875rem;" id="no-filter-msg">No filters selected - showing all files</span>
            </div>
        </section>
        
        <!-- Files Display -->
        <section class="files-section">
            <div class="files-header">
                <h3 id="files-title">üìÅ Files</h3>
                <button class="upload-btn" onclick="openModal()">‚ûï Upload</button>
            </div>
            <div class="files-grid" id="files-grid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>
    </main>
    
    <!-- Upload Modal -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Upload New File</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="file-label">Select File</label>
                    <input type="file" id="file-input">
                </div>
                <div class="form-group">
                    <label id="desc-label">Description</label>
                    <textarea id="file-desc" placeholder="Add notes..."></textarea>
                </div>
                <div class="form-group">
                    <label id="tags-label">Select Categories (click icons)</label>
                    <div class="tag-grid-selector" id="tag-selector">
                        <!-- Mini grid for tag selection -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()" id="cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="doUpload()" id="upload-btn">Upload</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        
        // 5x5 C-Grid configuration based on cgrid.jpg
        const CGRID_CONFIG = [
            // Row 1
            { id: 'gold', en: 'Finance', zh: 'ÈáëËûç', icon: 'icons/gold.jpg', dimension: 'WHAT' },
            { id: 'edu', en: 'Education', zh: 'ÊïôËÇ≤', icon: 'icons/edu.jpg', dimension: 'WHEN' },
            { id: 'res', en: 'Resources', zh: 'ËµÑÊ∫ê', icon: 'icons/res.jpg', dimension: 'WHAT' },
            { id: 'pub', en: 'Publication', zh: 'Âá∫Áâà', icon: 'icons/pub.jpg', dimension: 'HOW' },
            { id: 'biz', en: 'Business', zh: 'ÂïÜ‰∏ö', icon: 'icons/biz.jpg', dimension: 'WHO' },
            // Row 2
            { id: 'arch', en: 'Archive', zh: 'Ê°£Ê°à', icon: 'icons/arch.jpg', dimension: 'WHERE' },
            { id: 'mot', en: 'Time', zh: 'Êó∂Èó¥', icon: 'icons/mot.jpg', dimension: 'WHEN' },
            { id: 'dir', en: 'Documents', zh: 'ÊñáÊ°£', icon: 'icons/dir.jpg', dimension: 'WHAT' },
            { id: 'job', en: 'Career', zh: 'ËÅå‰∏ö', icon: 'icons/job.jpg', dimension: 'HOW' },
            { id: 'com', en: 'Commerce', zh: 'Ë¥∏Êòì', icon: 'icons/com.jpg', dimension: 'WHO' },
            // Row 3
            { id: 'lan', en: 'Language', zh: 'ËØ≠Ë®Ä', icon: 'icons/lan.jpg', dimension: 'WHERE' },
            { id: 'exp', en: 'Experience', zh: 'ÁªèÂéÜ', icon: 'icons/exp.jpg', dimension: 'WHEN' },
            { id: 'name', en: 'Identity', zh: 'Ë∫´‰ªΩ', icon: 'icons/name.jpg', dimension: 'WHAT', isCenter: true },
            { id: 'post', en: 'Mail', zh: 'ÈÇÆ‰ª∂', icon: 'icons/post.jpg', dimension: 'HOW' },
            { id: 'sys', en: 'System', zh: 'Á≥ªÁªü', icon: 'icons/sys.jpg', dimension: 'WHO' },
            // Row 4
            { id: 'loc', en: 'Location', zh: '‰ΩçÁΩÆ', icon: 'icons/loc.jpg', dimension: 'WHERE' },
            { id: 'info', en: 'Info', zh: '‰ø°ÊÅØ', icon: 'icons/info.jpg', dimension: 'WHEN' },
            { id: 'tree', en: 'Family', zh: 'ÂÆ∂Â∫≠', icon: 'icons/tree.jpg', dimension: 'WHAT' },
            { id: 'net', en: 'Network', zh: 'ÁΩëÁªú', icon: 'icons/net.jpg', dimension: 'HOW' },
            { id: 'gov', en: 'Government', zh: 'ÊîøÂ∫ú', icon: 'icons/gov.jpg', dimension: 'WHO' },
            // Row 5
            { id: 'neon', en: 'New', zh: 'Êñ∞Âª∫', icon: 'icons/neon.jpg', dimension: 'WHERE' },
            { id: 'dic', en: 'Dictionary', zh: 'ËØçÂÖ∏', icon: 'icons/dic.jpg', dimension: 'WHEN' },
            { id: 'proj', en: 'Project', zh: 'È°πÁõÆ', icon: 'icons/proj.jpg', dimension: 'WHAT' },
            { id: 'org', en: 'Organization', zh: 'ÁªÑÁªá', icon: 'icons/org.jpg', dimension: 'HOW' },
            { id: 'cir', en: 'Circle', zh: 'ÂúàÂ≠ê', icon: 'icons/cir.jpg', dimension: 'WHO' },
        ];
        
        let state = {
            lang: 'en',
            selectedCells: [], // Array of selected cell IDs
            files: []
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderCGrid();
            renderTagSelector();
            loadFiles();
        });
        
        // Render the 5x5 C-Grid
        function renderCGrid() {
            const grid = document.getElementById('cgrid');
            let html = '';
            
            CGRID_CONFIG.forEach((cell, index) => {
                const isSelected = state.selectedCells.includes(cell.id);
                const label = state.lang === 'zh' ? cell.zh : cell.en;
                const colNum = (index % 5) + 1; // Column 1-5
                
                html += `
                    <div class="cgrid-cell col-${colNum} ${isSelected ? 'selected' : ''} ${cell.isCenter ? 'center-cell' : ''}" 
                         onclick="toggleCell('${cell.id}')"
                         title="${cell.en} / ${cell.zh}">
                        <img src="${cell.icon}" alt="${cell.en}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2220%22>${cell.en.charAt(0)}</text></svg>'">
                        <div class="label">${label}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // Render mini grid for tag selection in upload modal
        function renderTagSelector() {
            const selector = document.getElementById('tag-selector');
            let html = '';
            
            CGRID_CONFIG.forEach(cell => {
                if (cell.isCenter) return; // Skip center cell for uploads
                html += `
                    <div class="mini-cell" data-id="${cell.id}" onclick="toggleUploadCell(this, '${cell.id}')" title="${cell.en} / ${cell.zh}">
                        <img src="${cell.icon}" alt="${cell.en}">
                    </div>
                `;
            });
            
            selector.innerHTML = html;
        }
        
        // Toggle cell selection
        function toggleCell(cellId) {
            const index = state.selectedCells.indexOf(cellId);
            if (index > -1) {
                state.selectedCells.splice(index, 1);
            } else {
                state.selectedCells.push(cellId);
            }
            
            renderCGrid();
            renderSelectedTags();
            loadFiles();
        }
        
        // Clear all filters
        function clearFilters() {
            state.selectedCells = [];
            renderCGrid();
            renderSelectedTags();
            loadFiles();
        }
        
        // Render selected tags display
        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            
            if (state.selectedCells.length === 0) {
                container.innerHTML = `<span style="color: var(--text-sec); font-size: 0.875rem;" id="no-filter-msg">${state.lang === 'zh' ? 'Êú™ÈÄâÊã©Á≠õÈÄâÊù°‰ª∂ - ÊòæÁ§∫ÊâÄÊúâÊñá‰ª∂' : 'No filters selected - showing all files'}</span>`;
                return;
            }
            
            let html = '';
            state.selectedCells.forEach(cellId => {
                const cell = CGRID_CONFIG.find(c => c.id === cellId);
                if (cell) {
                    const label = state.lang === 'zh' ? cell.zh : cell.en;
                    html += `
                        <div class="selected-tag">
                            <img src="${cell.icon}" alt="${cell.en}">
                            <span>${label}</span>
                            <span class="remove" onclick="toggleCell('${cell.id}')">√ó</span>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        // Load files from API
        async function loadFiles() {
            const grid = document.getElementById('files-grid');
            
            try {
                // Map selected cells to tag IDs (for now, use simple mapping)
                const tagParams = state.selectedCells.length > 0 
                    ? `?tags=${state.selectedCells.join(',')}` 
                    : '';
                
                const response = await fetch(`${API}/files${tagParams}`);
                const data = await response.json();
                
                if (data.success) {
                    state.files = data.data;
                    document.getElementById('file-count').textContent = state.files.length;
                    renderFiles();
                } else {
                    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading files</p></div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                // Show demo files if API not available
                state.files = getDemoFiles();
                document.getElementById('file-count').textContent = state.files.length;
                renderFiles();
            }
        }
        
        // Demo files for offline testing
        function getDemoFiles() {
            return [
                { id: 1, original_filename: 'family_photo.jpg', mime_type: 'image/jpeg', description: 'Family vacation in Paris', tags: ['tree', 'loc', 'exp'] },
                { id: 2, original_filename: 'quarterly_report.pdf', mime_type: 'application/pdf', description: 'Q3 2024 business report', tags: ['biz', 'dir', 'proj'] },
                { id: 3, original_filename: 'school_certificate.pdf', mime_type: 'application/pdf', description: 'Education certificate', tags: ['edu', 'dir'] },
                { id: 4, original_filename: 'invoice_2024.pdf', mime_type: 'application/pdf', description: 'Business invoice', tags: ['gold', 'biz', 'dir'] },
                { id: 5, original_filename: 'travel_memories.jpg', mime_type: 'image/jpeg', description: 'Travel photos', tags: ['loc', 'exp'] },
                { id: 6, original_filename: 'contact_list.xlsx', mime_type: 'application/excel', description: 'Network contacts', tags: ['net', 'org', 'info'] },
            ];
        }
        
        // Render files
        function renderFiles() {
            const grid = document.getElementById('files-grid');
            
            // Filter files based on selected cells
            let filteredFiles = state.files;
            if (state.selectedCells.length > 0) {
                filteredFiles = state.files.filter(file => {
                    const fileTags = file.tags || [];
                    return state.selectedCells.some(cell => fileTags.includes(cell));
                });
            }
            
            if (filteredFiles.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üìÇ</div>
                        <h3>${state.lang === 'zh' ? 'Êú™ÊâæÂà∞Êñá‰ª∂' : 'No files found'}</h3>
                        <p>${state.lang === 'zh' ? 'Â∞ùËØï‰∏çÂêåÁöÑÁ≠õÈÄâÊù°‰ª∂Êàñ‰∏ä‰º†Êñ∞Êñá‰ª∂' : 'Try different filters or upload a new file'}</p>
                    </div>
                `;
                document.getElementById('file-count').textContent = '0';
                return;
            }
            
            document.getElementById('file-count').textContent = filteredFiles.length;
            
            let html = '';
            filteredFiles.forEach(file => {
                const icon = getFileIcon(file.mime_type);
                html += `
                    <div class="file-card">
                        <div class="file-preview">${icon}</div>
                        <div class="file-info">
                            <div class="file-name" title="${file.original_filename}">${file.original_filename}</div>
                            ${file.description ? `<div style="font-size:0.7rem;color:var(--text-sec);margin-bottom:0.25rem;">${file.description}</div>` : ''}
                            <div class="file-tags">
                                ${(file.tags || []).slice(0, 4).map(tagId => {
                                    const cell = CGRID_CONFIG.find(c => c.id === tagId);
                                    return cell ? `<span class="file-tag">${state.lang === 'zh' ? cell.zh : cell.en}</span>` : '';
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // Upload modal
        let uploadSelectedCells = [];
        
        function openModal() {
            uploadSelectedCells = [];
            document.getElementById('upload-modal').classList.add('active');
            document.getElementById('file-input').value = '';
            document.getElementById('file-desc').value = '';
            // Reset tag selector
            document.querySelectorAll('.tag-grid-selector .mini-cell').forEach(el => el.classList.remove('selected'));
        }
        
        function closeModal() {
            document.getElementById('upload-modal').classList.remove('active');
        }
        
        function toggleUploadCell(el, cellId) {
            el.classList.toggle('selected');
            const index = uploadSelectedCells.indexOf(cellId);
            if (index > -1) {
                uploadSelectedCells.splice(index, 1);
            } else {
                uploadSelectedCells.push(cellId);
            }
        }
        
        async function doUpload() {
            const fileInput = document.getElementById('file-input');
            const desc = document.getElementById('file-desc').value;
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert(state.lang === 'zh' ? 'ËØ∑ÈÄâÊã©Êñá‰ª∂' : 'Please select a file');
                return;
            }
            
            if (uploadSelectedCells.length === 0) {
                if (!confirm(state.lang === 'zh' ? 'Êú™ÈÄâÊã©ÂàÜÁ±ªÔºåÁªßÁª≠Ôºü' : 'No categories selected. Continue?')) {
                    return;
                }
            }
            
            // Add to demo files (in real app, would upload to server)
            const newFile = {
                id: state.files.length + 1,
                original_filename: fileInput.files[0].name,
                mime_type: fileInput.files[0].type,
                description: desc,
                tags: uploadSelectedCells
            };
            
            state.files.push(newFile);
            closeModal();
            renderFiles();
            alert(state.lang === 'zh' ? '‰∏ä‰º†ÊàêÂäüÔºÅ' : 'Upload successful!');
        }
        
        // Language toggle
        function toggleLang() {
            state.lang = state.lang === 'en' ? 'zh' : 'en';
            document.getElementById('lang-ind').textContent = state.lang === 'en' ? 'EN/‰∏≠' : '‰∏≠/EN';
            
            // Update UI text
            document.getElementById('grid-title').textContent = state.lang === 'zh' ? 'C-Grid ÂØºËà™Âô®' : 'C-Grid Navigator';
            document.getElementById('grid-subtitle').textContent = state.lang === 'zh' ? 'ÁÇπÂáªÂõæÊ†áÁ≠õÈÄâÊñá‰ª∂' : 'Click icons to filter your files by category';
            document.getElementById('files-label').textContent = state.lang === 'zh' ? '‰∏™Êñá‰ª∂' : 'files found';
            document.getElementById('clear-btn').textContent = state.lang === 'zh' ? 'Ê∏ÖÈô§ÂÖ®ÈÉ®' : 'Clear All';
            document.getElementById('files-title').textContent = state.lang === 'zh' ? 'üìÅ Êñá‰ª∂' : 'üìÅ Files';
            document.getElementById('modal-title').textContent = state.lang === 'zh' ? '‰∏ä‰º†Êñ∞Êñá‰ª∂' : 'Upload New File';
            document.getElementById('file-label').textContent = state.lang === 'zh' ? 'ÈÄâÊã©Êñá‰ª∂' : 'Select File';
            document.getElementById('desc-label').textContent = state.lang === 'zh' ? 'ÊèèËø∞' : 'Description';
            document.getElementById('tags-label').textContent = state.lang === 'zh' ? 'ÈÄâÊã©ÂàÜÁ±ªÔºàÁÇπÂáªÂõæÊ†áÔºâ' : 'Select Categories (click icons)';
            document.getElementById('cancel-btn').textContent = state.lang === 'zh' ? 'ÂèñÊ∂à' : 'Cancel';
            document.getElementById('upload-btn').textContent = state.lang === 'zh' ? '‰∏ä‰º†' : 'Upload';
            
            renderCGrid();
            renderSelectedTags();
            renderFiles();
        }
        
        // Helper: Get file icon
        function getFileIcon(mimeType) {
            if (!mimeType) return 'üìÑ';
            if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
            if (mimeType.startsWith('video/')) return 'üé¨';
            if (mimeType.startsWith('audio/')) return 'üéµ';
            if (mimeType.includes('pdf')) return 'üìï';
            if (mimeType.includes('word')) return 'üìù';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'üìä';
            if (mimeType.includes('presentation')) return 'üìΩÔ∏è';
            return 'üìÑ';
        }
    </script>
</body>
</html>
